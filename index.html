<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Entrenador d’Intervals Musicals</title>
<style>
:root{
  --bg:#0f1114; --card:#181a1d; --panel:#0b0b0c; --text:#e6edf3;
  --muted:#9aa4ad; --primary:#0A84FF; --primary-hover:#339CFF;
  --success:#30D158; --danger:#FF453A; --white-note-bg:#ffffff;
}
body{margin:0;font-family:Inter,system-ui,-apple-system,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
.wrap{max-width:980px;margin:24px auto;padding:20px;}
.card{background:var(--card);border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,0.6);}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
h1{margin:0;color:var(--primary);font-size:20px;}
.lead{margin:6px 0 0 0;color:var(--muted);font-size:13px;}
#vf-container{border-radius:10px;background:var(--white-note-bg);padding:12px;min-height:170px;display:flex;align-items:center;justify-content:center;margin-top:18px;}
.controls-wrap{margin-top:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
select,button{font-size:14px;padding:10px 14px;border-radius:10px;border:none;outline:none;}
select{min-width:180px;background:#0f1720;color:var(--text);}
button.primary{background:var(--primary);color:#fff;cursor:pointer;transition:all .14s;border-radius:10px;}
button.primary:hover{background:var(--primary-hover);}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);cursor:pointer;border-radius:10px;}
button.disabled{opacity:.45;cursor:not-allowed;}
.badge{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:10px;color:var(--muted);font-size:13px;}
.message{margin-top:12px;padding:12px;border-radius:10px;display:none;font-weight:700;opacity:0;transition:opacity .25s;}
.ok{background:rgba(48,209,88,0.12);color:var(--success);}
.bad{background:rgba(255,69,58,0.08);color:var(--danger);}
.meta{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap;color:var(--muted);font-size:13px;}
#startBtn{font-size:15px;padding:12px 18px;}
@media (max-width:700px){
  #vf-container{min-height:150px}
  select{min-width:140px}
  .controls-wrap{flex-direction:column;align-items:stretch}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div>
        <h1>Entrenador d’Intervals Musicals</h1>
        <div class="lead">Rang A3 → G5 · accidentals aleatoris · pràctica infinita</div>
      </div>
      <div>
        <button id="startBtn" class="primary">Inicia Exercici</button>
      </div>
    </div>
    <div id="vf-container"></div>
    <div class="controls-wrap">
      <div class="controls">
        <select id="intervalSelect"></select>
        <select id="dirSelect">
          <option value="asc">Ascendent</option>
          <option value="desc">Descendent</option>
        </select>
        <button id="confirmBtn" class="primary">Confirma</button>
        <button id="nextBtn" class="ghost">Següent</button>
      </div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:10px">
        <div style="font-size:13px;color:var(--muted)">Temps:</div>
        <div id="timer" class="badge">20s</div>
      </div>
    </div>
    <div id="message" class="message"></div>
    <div class="meta">
      <div>Intents: <span id="attempts" class="badge">0</span></div>
      <div>Encerts: <span id="correct" class="badge">0</span></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/vexflow@4.2.5/build/cjs/vexflow.js"></script>
<script>
const VF = Vex.Flow;
const START_TIME = 20;
const INTERVALS = [
  {semitones:0,name:'Uníson',tones:'0'},
  {semitones:1,name:'2a menor',tones:'½'},
  {semitones:2,name:'2a major',tones:'1'},
  {semitones:3,name:'3a menor',tones:'1½'},
  {semitones:4,name:'3a major',tones:'2'},
  {semitones:5,name:'4a justa',tones:'2½'},
  {semitones:6,name:'Tritó',tones:'3'},
  {semitones:7,name:'5a justa',tones:'3½'},
  {semitones:8,name:'6a menor',tones:'4'},
  {semitones:9,name:'6a major',tones:'4½'},
  {semitones:10,name:'7a menor',tones:'5'},
  {semitones:11,name:'7a major',tones:'5½'},
  {semitones:12,name:'Octava',tones:'6'}
];

// Notes DB amb accidentals
const NOTES = [];
const noteNames = ['A','B','C','D','E','F','G'];
const octaves = [3,4,5];
const semitoneMap = {'C':0,'D':2,'E':4,'F':5,'G':7,'A':9,'B':11};
octaves.forEach(oct=>{
  noteNames.forEach(l=>{
    const baseSem = 12*(oct+1)+semitoneMap[l];
    // natural
    NOTES.push({display:`${l}${oct}`,letter:l,acc:null,oct:oct,sem:baseSem});
    // sostingut
    if(l!=='E' && l!=='B') NOTES.push({display:`${l}#${oct}`,letter:l,acc:'#',oct:oct,sem:baseSem+1});
    // bemoll
    if(l!=='C' && l!=='F') NOTES.push({display:`${l}b${oct}`,letter:l,acc:'b',oct:oct,sem:baseSem-1});
  });
});

// Estat app
const app={n1:null,n2:null,currentSemitones:null,currentDir:null,attempts:0,correct:0,timer:null,startTime:null,lock:false,lastPairs:[]};

// UI
const vfContainer = document.getElementById('vf-container');
const intervalSelect = document.getElementById('intervalSelect');
const dirSelect = document.getElementById('dirSelect');
const timerEl = document.getElementById('timer');
const messageEl = document.getElementById('message');
const attemptsEl = document.getElementById('attempts');
const correctEl = document.getElementById('correct');
const startBtn = document.getElementById('startBtn');
const confirmBtn = document.getElementById('confirmBtn');
const nextBtn = document.getElementById('nextBtn');

function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function getRandomNote(){return NOTES[randInt(0,NOTES.length-1)];}
function buildIntervalOptions(){
  intervalSelect.innerHTML='';
  INTERVALS.forEach(i=>{
    const opt=document.createElement('option');
    opt.value=i.semitones;
    opt.textContent=`${i.name} (${i.tones} t.)`;
    intervalSelect.appendChild(opt);
  });
}
buildIntervalOptions();

function generateInterval(){
  app.lock = true;
  vfContainer.innerHTML = '';

  const renderer = new VF.Renderer(vfContainer, VF.Renderer.Backends.SVG);
  renderer.resize(vfContainer.clientWidth, 150);
  const context = renderer.getContext();

  const stave = new VF.Stave(10, 40, vfContainer.clientWidth - 20);
  stave.addClef('treble').setContext(context).draw();

  let n1, n2;
  do {
    n1 = getRandomNote();
    n2 = getRandomNote();
  } while(app.lastPairs.some(p => p[0]===n1.display && p[1]===n2.display) || Math.abs(n1.sem-n2.sem)>12);

  app.lastPairs.push([n1.display, n2.display]);
  if(app.lastPairs.length>10) app.lastPairs.shift();

  app.n1 = n1;
  app.n2 = n2;
  app.currentSemitones = Math.abs(n1.sem - n2.sem);
  app.currentDir = n1.sem < n2.sem ? 'asc':'desc';

  // Crear notes
  const vfNotes = [
    new VF.StaveNote({ keys: [`${n1.letter}/${n1.oct}`], duration: 'q' }),
    new VF.StaveNote({ keys: [`${n2.letter}/${n2.oct}`], duration: 'q' })
  ];
  if(n1.acc) vfNotes[0].addModifier(0,new VF.Accidental(n1.acc));
  if(n2.acc) vfNotes[1].addModifier(0,new VF.Accidental(n2.acc));

  const voice = new VF.Voice({ num_beats:2, beat_value:4 });
  voice.addTickables(vfNotes);
  new VF.Formatter().joinVoices([voice]).format([voice], vfContainer.clientWidth-60);
  voice.draw(context, stave);

  app.lock=false;
}

function startTimer(){
  clearInterval(app.timer);
  app.startTime=START_TIME;
  timerEl.textContent=`${START_TIME}s`;
  app.timer=setInterval(()=>{
    app.startTime--;
    if(app.startTime<=0){
      clearInterval(app.timer);
      timerEl.textContent='0s';
      showMessage('Temps esgotat!',false);
    }else{
      timerEl.textContent=`${app.startTime}s`;
    }
  },1000);
}

function showMessage(txt,ok){
  messageEl.textContent=txt;
  messageEl.className='message '+(ok?'ok':'bad');
  messageEl.style.display='block';
  setTimeout(()=>{messageEl.style.opacity=1;},10);
  setTimeout(()=>{messageEl.style.opacity=0;},1800);
}

confirmBtn.addEventListener('click',()=>{
  if(app.lock) return;
  app.attempts++;
  attemptsEl.textContent=app.attempts;
  const selSem=parseInt(intervalSelect.value);
  const selDir=dirSelect.value;
  if(selSem===app.currentSemitones && selDir===app.currentDir){
    app.correct++;
    correctEl.textContent=app.correct;
    showMessage('Correcte!',true);
  }else{
    showMessage(`Incorrecte! Era ${INTERVALS.find(i=>i.semitones===app.currentSemitones).name} ${app.currentDir==='asc'?'Ascendent':'Descendent'}`,false);
  }
});

nextBtn.addEventListener('click',()=>{
  if(app.lock) return;
  nextBtn.textContent='Carregant…';
  setTimeout(()=>{
    generateInterval();
    nextBtn.textContent='Següent';
  },100);
});

startBtn.addEventListener('click',()=>{
  generateInterval();
  startTimer();
  startBtn.disabled=true;
  startBtn.classList.add('disabled');
});
</script>
</body>
</html>
